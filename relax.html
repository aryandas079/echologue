<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relax | Echologue</title>
    <!-- Custom Favicon: Black background with white letter E -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22black%22/><text x=%2250%%22 y=%2250%%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 fill=%22white%22 font-family=%22Inter, sans-serif%22 font-weight=%22bold%22 font-size=%2260%22>E</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Playfair+Display:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #334155;
            overflow-x: hidden;
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Focus mode is now pure pitch black */
        .focus-active body {
            background: #000000;
            color: #f1f5f9;
        }

        #bg-video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
            background: transparent;
            transition: opacity 1s ease;
        }

        #bg-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            filter: blur(10px);
            transform: scale(1.1); 
            transition: opacity 1.5s ease;
        }

        #bg-video.visible {
            opacity: 0.5;
        }

        .focus-active #bg-video.visible {
            opacity: 0.1;
        }

        .serif {
            font-family: 'Playfair Display', serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 40px;
        }

        .focus-active .glass {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .timer-circle {
            transition: stroke-dashoffset 0.5s ease;
        }

        @keyframes pulse-slow {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.05); }
        }
        .bg-pulse {
            animation: pulse-slow 15s infinite ease-in-out;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden-view {
            display: none !important;
        }

        .theme-dropdown {
            transform: translateY(10px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .theme-dropdown.show {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        
        .main-container {
            width: 100%;
            max-width: 1024px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            z-index: 10;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            #main-header {
                padding: 1.5rem !important;
            }
            #branding-header {
                display: none;
            }
            .player-card {
                padding: 1.5rem !important;
                gap: 1.5rem !important;
            }
            .timer-svg {
                width: 280px !important;
                height: 280px !important;
            }
            #timer-display {
                font-size: 4rem !important;
            }
            #theme-controls {
                left: 1.5rem !important;
                bottom: 1.5rem !important;
            }
            #headphones-reminder {
                bottom: 6rem !important;
                width: 80%;
            }
        }

        /* Centering and orientation fix for shuffle button */
        #shuffle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 0;
        }
        #shuffle-btn svg {
            display: block;
        }
    </style>
</head>
<body>

    <!-- Audio Element -->
    <audio id="main-audio"></audio>

    <!-- Video Background Container -->
    <div id="bg-video-container">
        <video id="bg-video" autoplay muted loop playsinline></video>
    </div>

    <!-- Decorative Gradients -->
    <div id="bg-blob-1" class="fixed top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-50 rounded-full filter blur-[120px] bg-pulse z-[-1] transition-all duration-1000"></div>
    <div id="bg-blob-2" class="fixed bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-slate-200 rounded-full filter blur-[120px] bg-pulse z-[-1] transition-all duration-1000"></div>

    <!-- Persistent Header -->
    <header id="main-header" class="fixed top-0 left-0 w-full p-8 md:p-12 flex justify-between items-center z-50 transition-all duration-700">
        <div id="branding-header" class="text-[10px] tracking-[0.6em] uppercase opacity-40 font-semibold transition-opacity duration-700">Relax | Echologue</div>
        <button id="focus-btn-main" onclick="openFocusSetup()" class="glass px-8 py-3 text-[9px] uppercase tracking-[0.3em] font-bold hover:bg-white/60 transition-all shadow-md">
            Enter Focus Mode
        </button>
    </header>

    <div class="main-container">
        <!-- LANDING VIEW (Relax Mode) -->
        <div id="landing-view" class="flex flex-col items-center justify-center text-center gap-8 w-full max-w-2xl fade-in">
            <div class="space-y-2 mb-2">
                <h1 class="serif text-4xl md:text-5xl italic leading-tight opacity-90">Breathe in.</h1>
            </div>

            <div class="glass p-10 md:p-12 w-full player-card shadow-2xl border-white/40 flex flex-col items-center gap-10">
                <div class="relative group w-full flex flex-col items-center">
                    <div class="w-44 h-44 md:w-64 md:h-64 bg-slate-100/50 rounded-[40px] overflow-hidden shadow-2xl relative flex items-center justify-center">
                        <div id="music-visualizer" class="absolute inset-0 bg-black/5 flex items-end justify-center gap-1.5 md:gap-2 p-10 md:p-12 opacity-0 transition-opacity duration-500 z-10">
                            <div class="w-2 bg-slate-400 h-10 md:h-12 animate-bounce"></div>
                            <div class="w-2 bg-slate-400 h-20 md:h-24 animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 bg-slate-400 h-14 md:h-16 animate-bounce" style="animation-delay: 0.2s"></div>
                            <div class="w-2 bg-slate-400 h-18 md:h-20 animate-bounce" style="animation-delay: 0.3s"></div>
                        </div>
                        
                        <svg id="album-icon" class="w-16 h-16 md:w-24 md:h-24 opacity-5 transition-opacity duration-500" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                        </svg>
                    </div>

                    <button id="sync-btn" onclick="syncLocalFolder()" class="mt-6 glass px-6 py-2.5 text-[8px] md:text-[9px] uppercase tracking-widest font-bold whitespace-nowrap hover:bg-white/80 transition-all shadow-lg z-20">
                        Synchronize Folder
                    </button>
                </div>

                <div class="text-center space-y-3 px-4 w-full">
                    <h4 id="song-title" class="text-xl md:text-3xl font-light tracking-tight truncate max-w-full">Library Offline</h4>
                    <p id="library-status" class="text-[9px] md:text-[10px] uppercase tracking-[0.5em] opacity-30 font-bold">Waiting for connection...</p>
                </div>

                <div class="flex items-center gap-6 md:gap-14">
                    <button onclick="toggleShuffle()" id="shuffle-btn" class="opacity-20 hover:opacity-100 transition-all p-3 rounded-full hover:bg-white/20 hidden md:flex">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 3h5v5"></path>
                            <path d="M4 20L21 3"></path>
                            <path d="M21 16v5h-5"></path>
                            <path d="M15 15l6 6"></path>
                            <path d="M4 4l5 5"></path>
                        </svg>
                    </button>

                    <button onclick="prevSong()" class="hover:scale-110 transition-transform opacity-60 active:scale-90">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6L19 18V6z"/></svg>
                    </button>

                    <button onclick="toggleMusic()" class="w-16 h-16 md:w-24 md:h-24 rounded-full bg-slate-800 text-white flex items-center justify-center hover:bg-slate-950 transition-all shadow-2xl hover:scale-105 active:scale-90">
                        <svg id="music-play" xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="music-pause" class="hidden" xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>

                    <button onclick="nextSong()" class="hover:scale-110 transition-transform opacity-60 active:scale-90">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>

                    <button onclick="toggleShuffle()" id="shuffle-btn-mobile" class="opacity-20 hover:opacity-100 transition-all p-3 rounded-full hover:bg-white/20 flex md:hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 3h5v5"></path>
                            <path d="M4 20L21 3"></path>
                            <path d="M21 16v5h-5"></path>
                            <path d="M15 15l6 6"></path>
                            <path d="M4 4l5 5"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- FOCUS VIEW (Timer) -->
        <main id="focus-view" class="hidden-view flex-col items-center justify-center w-full max-w-5xl fade-in">
            <!-- Header for Terminate Session -->
            <div class="w-full flex justify-end items-center mb-4 md:mb-8 relative z-[60]">
                <button onclick="exitFocusMode()" class="opacity-40 hover:opacity-100 transition-opacity uppercase text-[9px] tracking-[0.4em] font-bold cursor-pointer">Terminate Session</button>
            </div>

            <div class="relative flex items-center justify-center mb-6 md:mb-10">
                <svg class="timer-svg w-64 h-64 md:w-[500px] md:h-[500px] transform -rotate-90">
                    <circle cx="50%" cy="50%" r="45%" stroke="rgba(255,255,255,0.04)" stroke-width="1" fill="transparent"/>
                    <circle id="progress-ring" cx="50%" cy="50%" r="45%" stroke="#94a3b8" stroke-width="4" fill="transparent" stroke-dasharray="1400" stroke-dashoffset="0" stroke-linecap="round" class="timer-circle"/>
                </svg>
                
                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                    <span id="timer-display" class="text-5xl md:text-9xl font-light tracking-tighter">00:00</span>
                    <span id="timer-label" class="text-[8px] md:text-[9px] uppercase tracking-[0.6em] opacity-30 mt-4 md:mt-8 font-semibold">Active Interval</span>
                </div>
            </div>

            <div class="flex flex-col items-center gap-10">
                <div class="flex items-center gap-8 md:gap-12 relative z-[60]">
                    <!-- Restart Button -->
                    <button onclick="resetTimer()" class="opacity-30 hover:opacity-100 transition-opacity cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    </button>
                    <button onclick="toggleTimer()" id="play-btn" class="w-16 h-16 md:w-24 md:h-24 rounded-full bg-white shadow-2xl flex items-center justify-center hover:scale-110 active:scale-95 transition-all focus:outline-none cursor-pointer">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#0f172a"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="pause-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#0f172a"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <div class="w-4 md:w-6"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- FOCUS SETUP MODAL -->
    <div id="focus-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden bg-black/60 backdrop-blur-3xl transition-all p-6">
        <div class="glass p-8 md:p-10 max-w-lg w-full flex flex-col items-center gap-8 md:gap-10 shadow-2xl scale-in border-white/40">
            <div class="text-center space-y-2">
                <h2 class="serif text-2xl md:text-3xl italic">Session Configuration</h2>
                <p class="text-[9px] md:text-[10px] uppercase tracking-widest opacity-40">Define your focus interval</p>
            </div>
            
            <div class="flex gap-4 md:gap-6 items-center">
                <div class="flex flex-col items-center gap-2">
                    <input type="number" id="focus-h" placeholder="00" min="0" max="23" class="w-12 md:w-20 h-12 md:h-20 text-2xl md:text-4xl text-center bg-transparent border-b border-slate-300 focus:outline-none focus:border-slate-800 transition-colors font-light">
                    <span class="text-[8px] md:text-[9px] uppercase tracking-widest opacity-40 font-bold">Hours</span>
                </div>
                <span class="text-2xl md:text-3xl opacity-20 mb-4 md:mb-6">:</span>
                <div class="flex flex-col items-center gap-2">
                    <input type="number" id="focus-m" placeholder="25" min="0" max="59" class="w-12 md:w-20 h-12 md:h-20 text-2xl md:text-4xl text-center bg-transparent border-b border-slate-300 focus:outline-none focus:border-slate-800 transition-colors font-light">
                    <span class="text-[8px] md:text-[9px] uppercase tracking-widest opacity-40 font-bold">Mins</span>
                </div>
                <span class="text-2xl md:text-3xl opacity-20 mb-4 md:mb-6">:</span>
                <div class="flex flex-col items-center gap-2">
                    <input type="number" id="focus-s" placeholder="00" min="0" max="59" class="w-12 md:w-20 h-12 md:h-20 text-2xl md:text-4xl text-center bg-transparent border-b border-slate-300 focus:outline-none focus:border-slate-800 transition-colors font-light">
                    <span class="text-[8px] md:text-[9px] uppercase tracking-widest opacity-40 font-bold">Secs</span>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 w-full">
                <button onclick="closeFocusSetup()" class="order-2 md:order-1 flex-1 px-8 py-3.5 rounded-full border border-slate-300 opacity-60 hover:opacity-100 hover:bg-white/20 transition-all uppercase text-[9px] tracking-widest font-bold">Dismiss</button>
                <button onclick="startCustomFocus()" class="order-1 md:order-2 flex-1 bg-slate-800 text-white px-8 py-3.5 rounded-full hover:bg-slate-950 hover:shadow-lg transition-all uppercase text-[9px] tracking-widest font-bold">Initiate Session</button>
            </div>
        </div>
    </div>

    <!-- Theme Selection -->
    <div id="theme-controls" class="fixed bottom-10 left-10 z-50 transition-all duration-700">
        <div id="theme-menu" class="theme-dropdown absolute bottom-full left-0 mb-4 w-44 md:w-48 glass p-2 shadow-2xl overflow-hidden">
            <button onclick="setTheme('default')" class="w-full text-left px-4 py-2.5 text-[9px] md:text-[10px] uppercase tracking-widest hover:bg-white/20 rounded-xl transition-colors font-semibold">fireplace</button>
            <button onclick="setTheme('rain')" class="w-full text-left px-4 py-2.5 text-[9px] md:text-[10px] uppercase tracking-widest hover:bg-white/20 rounded-xl transition-colors font-semibold">Rainy Window</button>
            <button onclick="setTheme('forest')" class="w-full text-left px-4 py-2.5 text-[9px] md:text-[10px] uppercase tracking-widest hover:bg-white/20 rounded-xl transition-colors font-semibold">Quiet Forest</button>
            <button onclick="setTheme('library')" class="w-full text-left px-4 py-2.5 text-[9px] md:text-[10px] uppercase tracking-widest hover:bg-white/20 rounded-xl transition-colors font-semibold">Old Library</button>
        </div>
        <button onclick="toggleThemeMenu()" class="glass px-5 md:px-6 py-3 text-[8px] md:text-[9px] uppercase tracking-[0.3em] font-bold hover:bg-white/60 transition-all shadow-md flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 19.07-1.41-1.41"/><path d="M12 22v2"/><path d="m6.34 17.66-1.41 1.41"/><path d="M2 12h2"/><path d="m7.76 7.76-1.41-1.41"/><circle cx="12" cy="12" r="4"/></svg>
            Scene
        </button>
    </div>

    <!-- Headphones Reminder -->
    <div id="headphones-reminder" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-40 pointer-events-none transition-all duration-700">
        <div class="text-[8px] md:text-[9px] uppercase tracking-[0.4em] md:tracking-[0.5em] opacity-30 font-medium text-center">
            Use headphones for an immersive experience
        </div>
    </div>

    <script>
        let playlist = []; 
        let currentSongIndex = 0;
        let isShuffle = false;
        const audio = document.getElementById('main-audio');
        const songTitleDisplay = document.getElementById('song-title');
        const statusDisplay = document.getElementById('library-status');
        const albumIcon = document.getElementById('album-icon');

        async function autoSyncLibrary() {
            const hostname = window.location.hostname;
            const path = window.location.pathname;
            if (hostname.includes('github.io')) {
                const user = hostname.split('.')[0];
                const repo = path.split('/')[1] || '';
                try {
                    const response = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/relax`);
                    if (response.ok) {
                        const data = await response.json();
                        const songs = data.filter(file => isAudioFile(file.name)).map(file => ({ name: file.name, url: `relax/${file.name}` }));
                        if (songs.length > 0) { playlist = songs; setupLibrary(); document.getElementById('sync-btn').classList.add('hidden'); }
                    }
                } catch (e) { statusDisplay.textContent = "Auto-sync failed. Use Sync button."; }
            } else { statusDisplay.textContent = "Local folder 'relax/' required"; }
        }

        async function syncLocalFolder() {
            try {
                const dirHandle = await window.showDirectoryPicker();
                const files = [];
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file' && isAudioFile(entry.name)) {
                        const file = await entry.getFile();
                        files.push({ name: file.name, url: URL.createObjectURL(file) });
                    }
                }
                if (files.length > 0) { playlist = files; setupLibrary(); document.getElementById('sync-btn').classList.add('hidden'); }
            } catch (err) { if (err.name !== 'AbortError') alert("Folder access is needed."); }
        }

        function isAudioFile(name) {
            const ext = name.split('.').pop().toLowerCase();
            return ['mp3', 'wav', 'ogg', 'm4a', 'aac'].includes(ext);
        }

        function cleanFileName(name) {
            return name.replace(/\.[^/.]+$/, "").replace(/[_]/g, " ").replace(/[-]/g, " ");
        }

        function setupLibrary() {
            currentSongIndex = 0;
            loadSong(0);
            statusDisplay.textContent = `${playlist.length} Tracks Synchronized`;
            albumIcon.style.opacity = "0.2";
        }

        function loadSong(index) {
            if (playlist.length === 0) return;
            const song = playlist[index];
            audio.src = song.url;
            songTitleDisplay.textContent = cleanFileName(song.name);
        }

        function toggleMusic() {
            if (playlist.length === 0) { syncLocalFolder(); return; }
            if (audio.paused) {
                audio.play();
                document.getElementById('music-play').classList.add('hidden');
                document.getElementById('music-pause').classList.remove('hidden');
                document.getElementById('music-visualizer').style.opacity = "1";
                albumIcon.style.opacity = "0";
            } else {
                audio.pause();
                document.getElementById('music-play').classList.remove('hidden');
                document.getElementById('music-pause').classList.add('hidden');
                document.getElementById('music-visualizer').style.opacity = "0";
                albumIcon.style.opacity = "0.2";
            }
        }

        function nextSong() {
            if (playlist.length === 0) return;
            if (isShuffle && playlist.length > 1) {
                let nextIndex;
                do { nextIndex = Math.floor(Math.random() * playlist.length); } while (nextIndex === currentSongIndex);
                currentSongIndex = nextIndex;
            } else { currentSongIndex = (currentSongIndex + 1) % playlist.length; }
            loadSong(currentSongIndex);
            audio.play();
            albumIcon.style.opacity = "0";
            document.getElementById('music-visualizer').style.opacity = "1";
            document.getElementById('music-play').classList.add('hidden');
            document.getElementById('music-pause').classList.remove('hidden');
        }

        function prevSong() {
            if (playlist.length === 0) return;
            if (isShuffle && playlist.length > 1) {
                let prevIndex;
                do { prevIndex = Math.floor(Math.random() * playlist.length); } while (prevIndex === currentSongIndex);
                currentSongIndex = prevIndex;
            } else { currentSongIndex = (currentSongIndex - 1 + playlist.length) % playlist.length; }
            loadSong(currentSongIndex);
            audio.play();
            albumIcon.style.opacity = "0";
            document.getElementById('music-visualizer').style.opacity = "1";
            document.getElementById('music-play').classList.add('hidden');
            document.getElementById('music-pause').classList.remove('hidden');
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            const btn = document.getElementById('shuffle-btn');
            const btnMob = document.getElementById('shuffle-btn-mobile');
            if (isShuffle) {
                btn.classList.add('opacity-100', 'bg-white/20'); btn.classList.remove('opacity-20');
                btnMob.classList.add('opacity-100', 'bg-white/20'); btnMob.classList.remove('opacity-20');
                showNotification("Shuffle: On");
            } else {
                btn.classList.remove('opacity-100', 'bg-white/20'); btn.classList.add('opacity-20');
                btnMob.classList.remove('opacity-100', 'bg-white/20'); btnMob.classList.add('opacity-20');
                showNotification("Shuffle: Off");
            }
        }

        function showNotification(text) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-24 left-1/2 -translate-x-1/2 glass px-6 py-2 text-[10px] uppercase tracking-widest font-bold z-[100] fade-in';
            notification.textContent = text;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2500);
        }

        audio.onended = nextSong;

        let totalSeconds = 0, timeLeft = 0, timerId = null, isRunning = false;
        const timerDisplay = document.getElementById('timer-display');
        const progressRing = document.getElementById('progress-ring');
        const dashArray = 1400;

        function updateDisplay() {
            const h = Math.floor(timeLeft / 3600), m = Math.floor((timeLeft % 3600) / 60), s = timeLeft % 60;
            timerDisplay.textContent = h > 0 ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` : `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            const offset = dashArray - (totalSeconds > 0 ? (timeLeft / totalSeconds) : 0) * dashArray;
            progressRing.style.strokeDashoffset = isNaN(offset) ? 0 : offset;
        }

        function toggleTimer() { isRunning ? pauseTimer() : startTimer(); }
        function startTimer() {
            if (timeLeft <= 0) return;
            isRunning = true;
            timerId = setInterval(() => { timeLeft--; updateDisplay(); if (timeLeft <= 0) { clearInterval(timerId); completeSession(); } }, 1000);
            document.getElementById('play-icon').classList.add('hidden');
            document.getElementById('pause-icon').classList.remove('hidden');
        }
        function pauseTimer() { isRunning = false; clearInterval(timerId); document.getElementById('play-icon').classList.remove('hidden'); document.getElementById('pause-icon').classList.add('hidden'); }
        function resetTimer() { pauseTimer(); timeLeft = totalSeconds; updateDisplay(); }

        function openFocusSetup() { document.getElementById('focus-modal').classList.remove('hidden'); }
        function closeFocusSetup() { document.getElementById('focus-modal').classList.add('hidden'); }
        function startCustomFocus() {
            const h = parseInt(document.getElementById('focus-h').value) || 0, m = parseInt(document.getElementById('focus-m').value) || 0, s = parseInt(document.getElementById('focus-s').value) || 0;
            const total = (h * 3600) + (m * 60) + s;
            if (total <= 0) return;
            totalSeconds = total; timeLeft = total; closeFocusSetup(); enterFocusUI(); updateDisplay(); startTimer();
        }

        function enterFocusUI() {
            document.body.parentElement.classList.add('focus-active');
            document.getElementById('landing-view').classList.add('hidden-view');
            document.getElementById('focus-btn-main').classList.add('hidden');
            document.getElementById('focus-view').classList.remove('hidden-view');
            document.getElementById('focus-view').classList.add('flex');
            
            // Hide and disable clicks on the persistent top header
            document.getElementById('main-header').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('headphones-reminder').classList.add('opacity-0');
            document.getElementById('theme-controls').classList.add('opacity-0', 'pointer-events-none');
        }

        function exitFocusMode() {
            pauseTimer();
            document.body.parentElement.classList.remove('focus-active');
            document.getElementById('landing-view').classList.remove('hidden-view');
            document.getElementById('focus-btn-main').classList.remove('hidden');
            document.getElementById('focus-view').classList.add('hidden-view');
            document.getElementById('focus-view').classList.remove('flex');
            
            // Re-enable clicks and visibility on branding elements
            document.getElementById('main-header').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('headphones-reminder').classList.remove('opacity-0');
            document.getElementById('theme-controls').classList.remove('opacity-0', 'pointer-events-none');
        }

        function toggleThemeMenu() { document.getElementById('theme-menu').classList.toggle('show'); }
        
        const videoThemes = {
            default: 'relax_video/standard.mp4',
            rain: 'relax_video/rainy window.mp4',
            forest: 'relax_video/quiet forest.mp4',
            library: 'relax_video/old library.mp4'
        };

        function setTheme(theme) {
            const video = document.getElementById('bg-video');
            const b1 = document.getElementById('bg-blob-1'), b2 = document.getElementById('bg-blob-2');
            video.src = videoThemes[theme];
            video.load();
            video.classList.add('visible');
            b1.style.opacity = "0.2"; b2.style.opacity = "0.2";
            document.getElementById('theme-menu').classList.remove('show');
        }

        function completeSession() {
            pauseTimer();
            const notification = document.createElement('div');
            notification.className = 'fixed top-10 left-1/2 -translate-x-1/2 glass px-10 py-5 shadow-2xl z-[100] fade-in serif italic text-lg border-white/50';
            notification.textContent = "Session completed. Take a moment to rest.";
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 6000);
        }

        autoSyncLibrary();
        updateDisplay();
    </script>
</body>
</html>
